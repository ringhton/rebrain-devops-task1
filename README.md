# Nginx

![nginx](https://webhostinggeeks.com/blog/wp-content/uploads/2023/05/Nginx_server-1200x705-optimized.png)

## Установка *nginx* на Linux

Поскольку Nginx доступен в репозиториях Ubuntu по умолчанию, его можно установить из этих репозиториев с помощью системного пакета `apt`.

Так как это первое наше взаимодействие с пакетом системы `apt` в этом сеансе, мы также обновим индекс локальных пакетов, чтобы получить доступ к актуальным спискам пакетов. Затем мы можем восстановить настройку `nginx`:

```
sudo apt update
sudo apt install nginx
```
> После принятия процедур `apt` выполнит установку Nginx и других зависимых зависимостей на вашем сервере.

## Настройка брандмауэра

Перед тестированием Nginx необходимо выполнить настройку программного обеспечения брандмауэра, чтобы разрешить доступ к службе. Nginx регистрирует себя как службу с помощью `ufw` после установки, упрощая доступ к Nginx.

Для вывода списка конфигураций приложений, которые известны `ufw`, необходимо ввести следующую команду:

```
sudo ufw app list
```

> Необходимо получить список профилей приложений:

```
Output
Available applications:
  Nginx Full
  Nginx HTTP
  Nginx HTTPS
  OpenSSH
```

Как показал вывод, есть три профиля, доступных для Nginx:

1.`Nginx Full`: этот профиль открывает порт 80 (обычный веб-трафик без шифрования) и порт 443 (трафик с шифрованием TLS/SSL)
2.`Nginx HTTP`: этот профиль открывает только порт 80 (обычный веб-трафик без шифрования)
3.`Nginx HTTPS`: этот профиль открывает только порт 443 (трафик с шифрованием TLS/SSL)

Рекомендуется применять самый ограничивающий профиль, который будет разрешать заданный трафик. Сейчас нам нужно будет разрешить трафик на порту 80.

Для активации можно ввести следующую команду:

```
sudo ufw allow 'Nginx HTTP'
```

Для проверки изменений введите:

```
sudo ufw status
```

Вывод укажет, какой трафик HTTP разрешен:

```
Output
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere
Nginx HTTP                 ALLOW       Anywhere 
OpenSSH (v6)               ALLOW       Anywhere (v6) 
Nginx HTTP (v6)            ALLOW       Anywhere (v6)
```

## Проверка веб-сервера

В конце процесса установки Ubuntu 20.04 запускает Nginx. Веб-сервер уже должен быть запущен и работать.

Используйте команду `systemd init system`, чтобы проверить работу службы:

```
systemctl status nginx
Output
● nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2020-04-20 16:08:19 UTC; 3 days ago
     Docs: man:nginx(8)
 Main PID: 2369 (nginx)
    Tasks: 2 (limit: 1153)
   Memory: 3.5M
   CGroup: /system.slice/nginx.service
           ├─2369 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
           └─2380 nginx: worker process
```

Вывод подтвердили, что служба успешно запущена. Однако лучше всего протестировать ее запуск посредством запроса страницы из Nginx.

Откройте страницу Nginx по умолчанию, чтобы подтвердить работу программного обеспечения через IP-адрес вашего сервера. Если вы не знаете IP-адрес вашего сервера, вы можете найти его с помощью инструмента [icanhazip.com](https://ipv4.icanhazip.com/) , который выдаст вам ваш публичный IP-адрес, полученный от другого расположения в Интернете:

```
curl -4 icanhazip.com
```

Когда вы узнаете IP-адрес вашего сервера, введите его в адресную строку браузера:

*http://`your_server_ip`*

Вы должны увидеть эту страницу:

![welcom to nginx](https://ubuntucommunity.s3.dualstack.us-east-2.amazonaws.com/original/2X/7/7504d83a9fe8c09d861b2f7c49e144ac773f0c0d.png)

> Если вы видите эту страницу, вы успешно установили Nginx на свой веб-сервер.

## Управление процессом Nginx

Ваш веб-сервер запущен и работает, и теперь мы изучим некоторые базовые команды управления.

Чтобы остановить веб-сервер, введите:

```
sudo systemctl stop nginx
```

Чтобы запустить остановленный веб-сервер, введите:

```
sudo systemctl start nginx
```

Чтобы остановить и снова запустить службу, введите:

```
sudo systemctl restart nginx
```

Если вы просто вносите изменения в конфигурацию, во многих случаях Nginx может перезагружаться без отключения соединений. Для этого введите:

```
sudo systemctl reload nginx
```

По умолчанию Nginx настроен на автоматический запуск при загрузке сервера. Если вы не хотите этого, вы можете отключить такое поведение с помощью следующей команды:

```
sudo systemctl disable nginx
```

Чтобы перезагрузить службу для запуска во время загрузки, введите:

```
sudo systemctl enable nginx
```
Вы научились выполнять базовые команды управления и должны быть готовы настроить сайт для размещения сразу нескольких доменов.

## Настройка блоков сервера (рекомендуется)

В Nginx на Ubuntu 20.04 по умолчанию включен один серверный блок, настроенный для вывода документов из директории /var/www/html. Хотя это хорошо работает для отдельного сайта, при хостинге нескольких сайтов это неудобно. Вместо изменения /var/www/html мы создадим в /var/www структуру директорий для нашего сайта your_domain, оставив /var/www/html как директорию по умолчанию для вывода в случае, если запросу клиента не соответствуют никакие другие сайты.

Создайте директорию для `your_domain` следующим образом, используя флаг `-p` для создания необходимых родительских директорий:

```
sudo mkdir -p /var/www/your_domain/html
```

Затем назначьте владение директорией с помощью переменной среды *$USER*:

```
sudo chown -R $USER:$USER /var/www/your_domain/html
```

Разрешения корневых директорий веб-сервера должны быть правильными, если вы не изменяли значение unmask, которое устанавливает разрешения файла по умолчанию. Чтобы убедиться, что разрешения корректны, позволить владельцу читать, писать и запускать файлы, а группам и другим пользователям разрешить только читать и запускать файлы, вы можете ввести следующую команду:

```
sudo chmod -R 755 /var/www/your_domain
```

Затем создайте в качестве примера страницу *index.html*, используя *nano* или свой любимый редактор:

```
nano /var/www/your_domain/html/index.html
```

Добавьте в страницу следующий образец кода HTML:

> /var/www/your_domain/html/index.html
```
<html>
    <head>
        <title>Welcome to your_domain!</title>
    </head>
    <body>
        <h1>Success!  The your_domain server block is working!</h1>
    </body>
</html>
```
Сохраните и закройте файл с помощью ввода CTRL и X, а затем Y и ENTER после завершения работы.

Для обслуживания этого контента Nginx необходимо создать серверный блок с правильными директивами. Вместо того чтобы изменять файл конфигурации по умолчанию напрямую, мы создадим новый файл в директории `/etc/nginx/sites-available/your_domain`:

```
sudo nano /etc/nginx/sites-available/your_domain
```

Введите следующий блок конфигурации, который похож на заданный по умолчанию, но обновлен с учетом новой директории и доменного имени:

*/etc/nginx/sites-available/your_domain*
```
server {
        listen 80;
        listen [::]:80;

        root /var/www/your_domain/html;
        index index.html index.htm index.nginx-debian.html;

        server_name your_domain www.your_domain;

        location / {
                try_files $uri $uri/ =404;
        }
}
```

Мы обновили конфигурацию *root* с указанием новой директории и заменили **server_name** на имя нашего домена.

Теперь мы активируем файл, создав ссылку в директории `sites-enabled`, который Nginx считывает при запуске:

```
sudo ln -s /etc/nginx/sites-available/your_domain /etc/nginx/sites-enabled/
```

> [!NOTE]
> Два серверных блока активированы и настроены для реагирования на запросы на основе директив *listen* и *server_name* (дополнительную информацию об обработке Nginx этих директив можно найти здесь):

| Sites       | Answers                                                                         |
| ----------- | ------------------------------------------------------------------------------- |
| your_domain | будет отвечать на запросы your_domain и www.your_domain                         | 
| default     | будет отвечать на любые запросы порта 80, не соответствующие двум другим блокам |

Чтобы избежать возможной проблемы с хэшированием памяти при добавлении дополнительных имен серверов, необходимо изменить одно значение в файле */etc/nginx/[nginx.conf](./nginx.conf)*. Откройте файл:

```
sudo nano /etc/nginx/nginx.conf
```

Найдите директиву *server_names_hash_bucket_size* и удалите символ #, чтобы раскомментировать строку. Если вы используете nano, вы можете быстро найти слова в файле, нажав CTRL и w.

*/etc/nginx/nginx.conf*
```
...
http {
    ...
    server_names_hash_bucket_size 64;
    ...
}
...
```

Сохраните файл и закройте его после завершения.

Проведите тестирования, чтобы убедиться в отсутствии ошибок синтаксиса в файлах Nginx:

```
sudo nginx -t
```

Если проблемы отсутствуют, перезапустите Nginx, чтобы активировать изменения:

```
sudo systemctl restart nginx
```

Теперь Nginx должен обслуживать ваше доменное имя. Вы можете проверить это, открыв в браузере адрес http://example.com, после чего должны увидеть примерно следующее:

![success](https://assets.digitalocean.com/articles/nginx_server_block_1404/first_block.png)

## Знакомство с важными файлами и директориями Nginx

Теперь вы научились управлять службой Nginx, и настало время познакомиться с несколькими важными директориями и файлами.

### Контент
- /var/www/html: веб-контент, в состав которого по умолчанию входит только показанная ранее страница Nginx по умолчанию, выводится из директории /var/www/html. Это можно изменить путем изменения файлов конфигурации Nginx.

### Конфигурация сервера
- /etc/nginx: директория конфигурации Nginx. Здесь хранятся все файлы конфигурации Nginx.
- /etc/nginx/nginx.conf: основной файл конфигурации Nginx. Его можно изменить для внесения изменений в глобальную конфигурацию Nginx.
- /etc/nginx/sites-available/: директория, где могут храниться серверные блоки для каждого сайта. Nginx не будет использовать файлы конфигурации из этой директории, если они не будут связаны с директорией sites-enabled. Обычно конфигурации серверных блоков записываются в эту директорию и активируются посредством ссылки на другую директорию.
- /etc/nginx/sites-enabled/: директория, где хранятся активные серверные блоки каждого узла. Они созданы посредством ссылки на файлы конфигурации в директории sites-available.
- /etc/nginx/snippets: в этой директории содержатся фрагменты конфигурации, которые можно включить в конфигурацию Nginx. Воспроизводимые сегменты конфигурации хорошо подходят для преобразования в сниппеты.

### Журналы сервера
- /var/log/nginx/access.log: каждый запрос к вашему веб-серверу регистрируется в этом файле журнала, если Nginx не настроен иначе.
- /var/log/nginx/error.log: любые ошибки Nginx будут регистрироваться в этом журнале.

